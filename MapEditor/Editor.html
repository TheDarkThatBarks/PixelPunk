<!DOCTYPE html>
<html>

<head>
    <title>SquareRPG Level Editor</title>
</head>

<style>
    #table {
        margin-top: 30px;
        margin-left: 30px;
        outline: thick solid white;
        /*border: 1px solid white;
        border-style: none;*/
        border-collapse: collapse;
    }

    .cell {
        color: rgb(204, 204, 204);
        background-color: rgb(12, 12, 12);
        caret-color: transparent;
        font-family: 'Consolas';
        letter-spacing: 0.001px;
        border: 0;
        outline: 0;
        text-align: center;
        /*font-size: 80px;
        width: 40px;
        height: 80px;*/
    }

    label {
        color: white;
    }
</style>

<script>
    const colors = ["rgb(12, 12, 12)", "rgb(0, 55, 218)", "rgb(19, 161, 14)", "rgb(58, 150, 221)",
                    "rgb(197, 15, 31)", "rgb(136, 23, 152)", "rgb(193, 156, 0)", "rgb(204, 204, 204)",
                    "rgb(118, 118, 118)", "rgb(59, 120, 255)", "rgb(22, 198, 12)", "rgb(97, 214, 214)",
                    "rgb(231, 72, 86)", "rgb(180, 0, 158)", "rgb(249, 241, 165)", "rgb(242, 242, 242)"];
    const BLACK = colors[0];
    const WHITE = colors[15];

    let cellWidth = 20;
    let width = 0;
    let height = 0;
    let frames = [[], []];
    let npcIDs = [];

    let cursorRow = 0;
    let cursorCol = 0;
    let currFrame = 0;
    let currPlayer = [-1, -1];
    let currStart = [-1, -1];

    // Sets the stored cursor position to the given coordinates and updates all visual elements on the page accordingly
    const setCursorPos = function (r, c) {
        document.querySelector(`#r${cursorRow}c${cursorCol}`).parentElement.style.outline = "none";
        cursorRow = r;
        cursorCol = c;
        const cell = document.querySelector(`#r${r}c${c}`);
        document.querySelector("#fore-color").value = frames[currFrame][r][c].fore;
        document.querySelector("#back-color").value = frames[currFrame][r][c].back;
        cell.parentElement.style.outline = "2px solid " + WHITE;
        cell.focus();
        setTimeout(() => {cell.selectionStart = cell.selectionEnd = 10000;}, 0);
        document.querySelector("#player").checked = frames[currFrame][r][c].isPlayer;
        document.querySelector("#npc").checked = frames[currFrame][r][c].isNPC;
        document.querySelector("#start").checked = frames[currFrame][r][c].isStart;
        const type = frames[currFrame][r][c].type;
        document.querySelector("#type").value = type;
        if (type === "!") {
            document.querySelector("#npc-id").value = npcIDs.find((e) => e.r === r && e.c === Math.floor(c / 2) * 2).id;
        } else {
            document.querySelector("#npc-id").value = "";
        }
    };
    
    // Adds the functionality for using arrow keys to move from cell to cell
    document.addEventListener("keydown", (event) => {
        let arrow = true;
        let rowChange = 0;
        let colChange = 0;
        switch (event.key) {
            case "ArrowUp":
                rowChange = cursorRow === 0 ? 0 : -1;
                break;
            case "ArrowDown":
                rowChange = cursorRow === height - 1 ? 0 : 1;
                break;
            case "ArrowLeft":
                colChange = cursorCol === 0 ? 0 : -1;
                break;
            case "ArrowRight":
                colChange = cursorCol === width - 1 ? 0 : 1;
                break;
            default:
                arrow = false;
        }
        if (arrow) {
            event.preventDefault();
            setCursorPos(cursorRow + rowChange, cursorCol + colChange);
        }
    });

    // Creates the map table with the user provided height and width
    const createTable = function () {
        width = document.querySelector("#width").value * 2;
        height = document.querySelector("#height").value;
        const table = document.querySelector("#table");
        table.hidden = false;
        table.innerHTML = "";
        frames = [[], []];
        for (let i = 0; i < height; i++) {
            let str = "<tr>";
            frames[0].push([]);
            frames[1].push([]);
            for (let j = 0; j < width; j++) {
                str += `<td width=${cellWidth}px height=${cellWidth * 2}px>
                            <input
                                style="font-size: ${cellWidth * 2}px; width: ${cellWidth}px; height: ${cellWidth * 2}px"
                                maxlength=1 class="cell" id="r${i}c${j}"
                                onfocus="setCursorPos(${i}, ${j})" oninput="changeVal(${i}, ${j})"
                            >
                        </td>`;
                for (const frame of frames)
                    frame[i].push({
                        type: " ",
                        value: "",
                        fore: 7,
                        back: 0,
                        isPlayer: false,
                        isEnemy: false,
                        isNPC: false,
                        isStart: false
                    });
            }
            table.innerHTML += str + "</tr>";
        }
        console.log(frames);
    };

    // Changes the stored value at coordinates on the map of the selected cell
    // If the changed cell is part of an NPC, changes the stored NPC ID accordingly
    const changeVal = function (r, c) {
        const val = document.querySelector(`#r${r}c${c}`).value;
        if (frames[currFrame][r][c].isNPC) {
            const col = Math.floor(c / 2) * 2;
            for (const frame of frames) {
                frame[r][col].value = val;
                frame[r][col + 1].value = val;
            }
            document.querySelector(`#r${r}c${col}`).value = val;
            document.querySelector(`#r${r}c${col + 1}`).value = val;
            const npcID = npcIDs.find((e) => e.r == r && e.c == col);
            npcID.id = (val || " ") + npcID.id.slice(1);
            document.querySelector("#npc-id").value = npcID.id;
        } else {
            frames[currFrame][r][c].value = val;
        }
        //console.log("changeVal", frames);
    };

    // Changes the text foreground color of the selected cell
    // If the changed cell is part of an NPC, changes the stored NPC ID accordingly
    const changeCellForeColor = function () {
        const color = document.querySelector("#fore-color").value;
        if (frames[currFrame][cursorRow][cursorCol].isNPC) {
            const col = Math.floor(cursorCol / 2) * 2;
            for (const frame of frames) {
                frame[cursorRow][col].fore = parseInt(color);
                frame[cursorRow][col + 1].fore = parseInt(color);
            }
            document.querySelector(`#r${cursorRow}c${col}`).style.color = colors[color];
            document.querySelector(`#r${cursorRow}c${col + 1}`).style.color = colors[color];
            const npcID = npcIDs.find((e) => e.r == cursorRow && e.c == col);
            npcID.id = npcID.id[0] + parseInt(color).toString(16) + npcID.id[2];
            document.querySelector("#npc-id").value = npcID.id;
        } else {
            const cell = document.querySelector(`#r${cursorRow}c${cursorCol}`);
            cell.style.color = colors[color];
            frames[currFrame][cursorRow][cursorCol].fore = parseInt(color);
        }
        //console.log(frames);
    };

    // Changes the text background color of the selected cell
    // If the changed cell is part of an NPC, changes the stored NPC ID accordingly
    const changeCellBackColor = function () {
        const color = document.querySelector("#back-color").value;
        if (frames[currFrame][cursorRow][cursorCol].isNPC) {
            const col = Math.floor(cursorCol / 2) * 2;
            for (const frame of frames) {
                frame[cursorRow][col].back = parseInt(color);
                frame[cursorRow][col + 1].back = parseInt(color);
            }
            const npcID = npcIDs.find((e) => e.r == cursorRow && e.c == col);
            npcID.id = npcID.id.slice(0, 2) + parseInt(color).toString(16);
            document.querySelector("#npc-id").value = npcID.id;
        } else {
            const cell = document.querySelector(`#r${cursorRow}c${cursorCol}`);
            cell.style.backgroundColor = colors[color];
            frames[currFrame][cursorRow][cursorCol].back = parseInt(color);
        }
        //console.log(frames);
    };

    let grid = false;

    // Toggles visibility of the cell grid of the map
    const toggleGrid = function () {
        document.querySelector("#table").border = grid ? "0" : "1px solid white";
        grid = !grid;
    };

    // Saves the map into an encoded string
    const save = function () {
        let foundPlayer = false;
        let foundStart = false;
        let str = `${(height < 10 ? "0" : "") + height}x${(width < 10 ? "0" : "") + width}`;
        for (let i = 0; i < height; i++) {
            str += '|';
            for (let j = 0; j < width; j++) {
                let cells = [];
                let player = false;
                let enemy = false;
                let npc = false;
                let start = false;
                for (const frame of frames) {
                    cells.push(frame[i][j].type + (frame[i][j].value || " ") + frame[i][j].fore.toString(16) + frame[i][j].back.toString(16));
                    player |= frame[i][j].isPlayer;
                    enemy != frame[i][j].isEnemy;
                    npc |= frame[i][j].isNPC;
                    start |= frame[i][j].isStart;
                    foundPlayer |= player;
                    foundStart |= start;
                }
                str += (start ? '^' : "") + cells[0];
                if (cells[0].slice(1) !== cells[1].slice(1))
                    str += '*' + cells[1].slice(1);
            }
        }
        document.querySelector("#map").value = str;
        navigator.clipboard.writeText(str);
        if (!foundPlayer)
            alert("Warning: Player location not found!");
        if (!foundStart)
            alert("Warning: Screen start location not found!");
    };

    // If frame == -1, loads a map from the text box with an encoded map string
    // If frame != -1, loads the current frame
    const load = function (frame) {
        if (frame === -1) {
            let map = document.querySelector("#map").value;
            height = parseInt(map.slice(0, 2));
            width = parseInt(map.slice(3, 5));
            let idx = 6, r = 0;
            let lastCell = "";
            frames = [[], []];
            npcIDs = [];
            for (let i = 0; i < height; i++) {
                frames[0].push([]);
                frames[1].push([]);
            }
            //console.log(JSON.parse(JSON.stringify(frames)));
            let start = false;
            while (idx < map.length) {
                const type = map[idx];
                if (type === '^') {
                    start = true;
                    idx++;
                    continue;
                } else if (type === '|') {
                    //console.log('|');
                    if (lastCell !== "" && lastCell.type !== '*')
                        frames[1][r].push(JSON.parse(JSON.stringify(lastCell)));
                    idx++;
                    r++;
                    lastCell = "";
                    continue;
                }
                const cellStr = map.slice(idx + 1, idx + 4);
                const cell = {
                    type: type,
                    value: cellStr[0] === " " ? "" : cellStr[0],
                    fore: parseInt(cellStr[1], 16),
                    back: parseInt(cellStr[2], 16),
                    isPlayer: type === '+',
                    isEnemy: type === '-',
                    isNPC: type === '!',
                    isStart: start
                };
                if (cell.isNPC) {
                    npcIDs.push({
                        r: r,
                        c: Math.floor(frames[0][r].length / 2) * 2,
                        id: cellStr
                    });
                }
                start = false;
                if (type === '*') {
                    cell.type = lastCell.type;
                    cell.isPlayer = lastCell.isPlayer;
                    cell.isEnemy = lastCell.isEnemy;
                    if (lastCell.isNPC) {
                        cell.isNPC = lastCell.isNPC;
                        cell.value = lastCell.value;
                        cell.fore = lastCell.fore;
                    }
                    cell.isStart = lastCell.isStart;
                    frames[1][r].push(JSON.parse(JSON.stringify(cell)));
                    cell.type = "*";
                } else {
                    frames[0][r].push(JSON.parse(JSON.stringify(cell)));
                    if (lastCell !== "" && lastCell.type !== '*')
                        frames[1][r].push(JSON.parse(JSON.stringify(lastCell)));
                }
                lastCell = JSON.parse(JSON.stringify(cell));
                idx += 4;
                //console.log(JSON.parse(JSON.stringify(frames)));
            }
            //console.log('|', c);
            if (lastCell !== "" && lastCell.type !== '*')
                frames[1][r].push(JSON.parse(JSON.stringify(lastCell)));
            cursorRow = 0;
            cursorCol = 0;
        }
        console.log("load", frames);

        const table = document.querySelector("#table");
        table.hidden = false;
        table.innerHTML = "";
        for (let i = 0; i < height; i++) {
            let str = "<tr>";
            for (let j = 0; j < width; j++) {
                const cell = frames[currFrame][i][j];
                //console.log(cell);
                if (cell.isPlayer && currPlayer[0] === -1)
                    currPlayer = [i, j];
                str += `<td width=${cellWidth}px height=${cellWidth * 2}px>
                            <input
                                value="${cell.value}"
                                style="font-size: ${cellWidth * 2}px; width: ${cellWidth}px; height: ${cellWidth * 2}px;
                                       color: ${colors[cell.isPlayer ? 5 : (cell.isEnemy ? 12 : cell.fore)]};
                                       background-color: ${colors[cell.isPlayer ? 5 : (cell.isEnemy ? 12 : (cell.isNPC ? 9 : cell.back))]};"
                                maxlength=1 class="cell" id="r${i}c${j}"
                                onfocus="setCursorPos(${i}, ${j})" oninput="changeVal(${i}, ${j})"
                            >
                        </td>`;
            }
            table.innerHTML += str + "</tr>";
        }
        setCursorPos(cursorRow, cursorCol);
    };

    // Changes the frame and reloads the map
    const changeFrame = function (frame) {
        currFrame = frame;
        load();
    };

    let playing = false;
    let playInterval;

    // Plays and stops the animation
    // Animation runs at 2 frames per second
    const play = function (button) {
        if (playing) {
            clearInterval(playInterval);
            playing = false;
            button.innerHTML = "Play";
        } else {
            playInterval = setInterval(() => {
                changeFrame(-currFrame + 1);
                document.querySelector(`#frame${currFrame + 1}`).checked = true;
            }, 500);
            playing = true;
            button.innerHTML = "Stop";
        }
    };

    // Copies the current frame to the non-selected frame
    const copyFrame = function () {
        frames[-currFrame + 1] = JSON.parse(JSON.stringify(frames[currFrame]));
        changeFrame(-currFrame + 1);
        document.querySelector(`#frame${currFrame + 1}`).checked = true;
    };

    // Sets the position of the player and changes the selected cell's visual fore- and back-ground colors accordingly, and changes the cell's type
    const setPlayer = function (checked) {
        const col = Math.floor(cursorCol / 2) * 2;
        for (const frame of frames) {
            frame[cursorRow][col].isPlayer = checked;
            frame[cursorRow][col + 1].isPlayer = checked;
        }
        //console.log(checked);
        if (currPlayer[0] !== -1) {
            //console.log("DEBUG");
            for (const frame of frames) {
                frame[currPlayer[0]][currPlayer[1]].isPlayer = false;
                frame[currPlayer[0]][currPlayer[1] + 1].isPlayer = false;
            }
            const cell1 = frames[currFrame][currPlayer[0]][currPlayer[1]];
            const cell2 = frames[currFrame][currPlayer[0]][currPlayer[1] + 1];
            document.querySelector(`#r${currPlayer[0]}c${currPlayer[1]}`).style.color = colors[cell1.fore];
            document.querySelector(`#r${currPlayer[0]}c${currPlayer[1]}`).style.backgroundColor = colors[cell1.back];
            document.querySelector(`#r${currPlayer[0]}c${currPlayer[1] + 1}`).style.color = colors[cell2.fore];
            document.querySelector(`#r${currPlayer[0]}c${currPlayer[1] + 1}`).style.backgroundColor = colors[cell2.back];
        }
        if (checked) {
            document.querySelector(`#r${cursorRow}c${col}`).style.color = colors[5];
            document.querySelector(`#r${cursorRow}c${col}`).style.backgroundColor = colors[5];
            document.querySelector(`#r${cursorRow}c${col + 1}`).style.color = colors[5];
            document.querySelector(`#r${cursorRow}c${col + 1}`).style.backgroundColor = colors[5];
            currPlayer = [cursorRow, col];
        } else {
            currPlayer = [-1, -1];
        }
        //console.log("setPlayer", JSON.parse(JSON.stringify(frames)));
    };

    // Changes the selected cell's visual fore- and back-ground colors accordingly, and changes the cell's type
    const setEnemy = function (checked) {
        const col = Math.floor(cursorCol / 2) * 2;
        for (const frame of frames) {
            frame[cursorRow][col].isEnemy = checked;
            frame[cursorRow][col + 1].isEnemy = checked;
        }
        if (checked) {
            document.querySelector(`#r${cursorRow}c${col}`).style.color = colors[12];
            document.querySelector(`#r${cursorRow}c${col}`).style.backgroundColor = colors[12];
            document.querySelector(`#r${cursorRow}c${col + 1}`).style.color = colors[12];
            document.querySelector(`#r${cursorRow}c${col + 1}`).style.backgroundColor = colors[12];
        } else {
            const cell1 = frames[currFrame][cursorRow][col];
            const cell2 = frames[currFrame][cursorRow][col + 1];
            document.querySelector(`#r${cursorRow}c${col}`).style.color = colors[cell1.fore];
            document.querySelector(`#r${cursorRow}c${col}`).style.backgroundColor = colors[cell1.back];
            document.querySelector(`#r${cursorRow}c${col + 1}`).style.color = colors[cell2.fore];
            document.querySelector(`#r${cursorRow}c${col + 1}`).style.backgroundColor = colors[cell2.back];
        }
    };

    // Changes the selected cell's visual background color accordingly, and changes the cell's type
    // Also records the coordinates of the NPC and creates its ID and stores both in the npcIDs list
    const setNPC = function (checked) {
        const col = Math.floor(cursorCol / 2) * 2;
        for (const frame of frames) {
            frame[cursorRow][col].isNPC = checked;
            frame[cursorRow][col + 1].isNPC = checked;
        }
        if (checked) {
            document.querySelector(`#r${cursorRow}c${col}`).style.backgroundColor = colors[9];
            document.querySelector(`#r${cursorRow}c${col + 1}`).style.backgroundColor = colors[9];
        } else {
            const cell1 = frames[currFrame][cursorRow][col];
            const cell2 = frames[currFrame][cursorRow][col + 1];
            document.querySelector(`#r${cursorRow}c${col}`).style.backgroundColor = colors[cell1.back];
            document.querySelector(`#r${cursorRow}c${col + 1}`).style.backgroundColor = colors[cell2.back];
        }
        npcIDs.push({
            r: cursorRow,
            c: col,
            id: (frames[currFrame][cursorRow][col].value || " ") + frames[currFrame][cursorRow][col].fore.toString(16) + frames[currFrame][cursorRow][col].back.toString(16)
        });
    };

    // Sets the position of the screen start and changes the selected cell's isStart value
    const setStart = function (checked) {
        const col = Math.floor(cursorCol / 2) * 2;
        for (const frame of frames) {
            frame[cursorRow][col].isStart = checked;
            frame[cursorRow][col + 1].isStart = checked;
            if (currStart[0] !== -1) {
                frame[currStart[0]][currStart[1]].isStart = false;
                frame[currStart[0]][currStart[1] + 1].isStart = false;
            }
        }
        currStart = checked ? [cursorRow, col] : [-1, -1];
    };

    // Changes the type of the selected cell
    const changeType = function () {
        const col = Math.floor(cursorCol / 2) * 2;
        const type = document.querySelector("#type").value;
        const oldType = frames[currFrame][cursorRow][col].type;
        if (oldType === "+") {
            setPlayer(false);
        } else if (oldType === "!") {
            setNPC(false);
        } else if (oldType === "-") {
            setEnemy(false);
        }
        if (type === "+") {
            setPlayer(true);
        } else if (type === "!") {
            setNPC(true);
        } else if (type === "-") {
            setEnemy(true);
        }
        for (const frame of frames) {
            for (let i = 0; i < 2; i++)
                frame[cursorRow][col + i].type = type;
        }
        console.log("changeType", frames);
    };

    // Changes the visual size of every cell in the interface
    const changeCellSize = function (newWidth) {
        cellWidth = newWidth;
        load();
    };
</script>

<body style="background-color: rgb(12, 12, 12)">
    <input type="number" placeholder="Width" id="width">
    <input type="number" placeholder="Height" id="height">
    <button onclick="createTable();">Generate Table</button>
    <br><br>
    <label for="grid">Toggle Grid</label>
    <input type="checkbox" id="grid" onchange="toggleGrid()">
    <label for="size">Cell Width (Pixels)</label>
    <input type="number" id="size" value="20" onchange="changeCellSize(this.value)">
    <br><br>
    <input type="radio" name="frame" id="frame1" value="1" onclick="changeFrame(0)" checked="true">
    <label for="frame1">Frame 1</label>
    <input type="radio" name="frame" id="frame2" value="2" onclick="changeFrame(1)">
    <label for="frame2">Frame 2</label>
    <button onclick="copyFrame()">Copy Frame</button>
    <button onclick="play(this)">Play</button>
    <br><br>
    <select id="fore-color" onchange="changeCellForeColor()">
        <option value="0">Black</option>
        <option value="1">Dark Blue</option>
        <option value="2">Green</option>
        <option value="3">Light Blue</option>
        <option value="4">Red</option>
        <option value="5">Purple</option>
        <option value="6">Yellow</option>
        <option value="7">Light Gray</option>
        <option value="8">Dark Gray</option>
        <option value="9">Blue</option>
        <option value="10">Light Green</option>
        <option value="11">Lightest Blue</option>
        <option value="12">Light Red</option>
        <option value="13">Light Purple</option>
        <option value="14">Light Yellow</option>
        <option value="15">White</option>
    </select>
    <select id="back-color" onchange="changeCellBackColor()">
        <option value="0">Black</option>
        <option value="1">Dark Blue</option>
        <option value="2">Green</option>
        <option value="3">Light Blue</option>
        <option value="4">Red</option>
        <option value="5">Purple</option>
        <option value="6">Yellow</option>
        <option value="7">Light Gray</option>
        <option value="8">Dark Gray</option>
        <option value="9">Blue</option>
        <option value="10">Light Green</option>
        <option value="11">Lightest Blue</option>
        <option value="12">Light Red</option>
        <option value="13">Light Purple</option>
        <option value="14">Light Yellow</option>
        <option value="15">White</option>
    </select>
    <select id="type" onchange="changeType()">
        <option value=" ">Empty</option>
        <option value=".">Wall</option>
        <option value="-">Enemy</option>
        <option value="!">NPC</option>
        <option value="+">Player</option>
    </select>
    <input id="npc-id" style="width: 50px" onclick="navigator.clipboard.writeText(this.value)" readonly>
    <br><br>
    <input type="checkbox" id="player" onclick="setPlayer(this.checked)">
    <label for="player">Player</label>
    <input type="checkbox" id="npc" onclick="setNPC(this.checked)">
    <label for="npc">NPC</label>
    <input type="checkbox" id="start" onclick="setStart(this.checked)">
    <label for="start">Screen Start</label>
    <br><br>
    <button onclick="save()">Save</button>
    <button onclick="load(-1)">Load</button>
    <textarea id="map"></textarea>
    <br><br>
    <table id="table" cellspacing="0" cellpadding="0" hidden></table>
</body>

</html>